name: Build macOS App

on: 
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build:
    runs-on: macos-latest
    timeout-minutes: 40

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Clean environment
      run: |
        brew uninstall --ignore-dependencies qt || true
        rm -rf /opt/homebrew/opt/qt*
        brew cleanup

    - name: Install Qt
      run: |
        brew update
        brew install qt@6
        echo "QT_PATH=/opt/homebrew/opt/qt@6" >> $GITHUB_ENV
        echo "PATH=$PATH:/opt/homebrew/opt/qt@6/bin" >> $GITHUB_ENV
        
        # Проверка macdeployqt
        if [ ! -f /opt/homebrew/opt/qt@6/bin/macdeployqt ]; then
          echo "❌ macdeployqt not found at:"
          find /opt/homebrew -name macdeployqt
          exit 1
        fi

    - name: Build application
      run: |
        cd app
        /opt/homebrew/opt/qt@6/bin/qmake la-calc.pro -spec macx-clang CONFIG+=release
        make -j$(sysctl -n hw.ncpu)
        
        # Проверка бинарника
        if [ ! -f la-calc.app/Contents/MacOS/la-calc ]; then
          echo "❌ Binary not found!"
          exit 1
        fi
        # Рекурсивный фикс прав
        chmod -R 755 la-calc.app

    - name: Deploy dependencies
      run: |
        mkdir -p dist
        cp -R app/la-calc.app dist/
        
        # Явная проверка существования приложения
        if [ ! -d dist/la-calc.app ]; then
          echo "❌ App bundle not found in dist/"
          exit 1
        fi
        
        # Принудительное копирование фреймворков с проверкой ошибок
        /opt/homebrew/opt/qt@6/bin/macdeployqt dist/la-calc.app \
          -verbose=3 \
          -always-overwrite \
          -codesign="-" || exit 1

    - name: Verify artifacts
      run: |
        # Проверка наличия entitlements
        if [ ! -f ./entitlements.plist ]; then
          echo "❌ entitlements.plist not found in root directory!"
          exit 1
        fi
        
        # Проверка структуры приложения
        ls -lR dist/

    - name: Hardened Runtime
      run: |
        # Включение Hardened Runtime
        codesign --deep --force --verbose \
          --options runtime \
          --entitlements ./entitlements.plist \
          --sign "-" \
          dist/la-calc.app

    - name: Create DMG with permissions
      run: |
        hdiutil create -fs HFS+ \
          -volname "Linear Algebra Calculator" \
          -srcfolder dist/la-calc.app \
          -ov -format UDZO \
          -uid 99 \
          -gid 99 \
          -mode 755 \
          dist/la-calc.dmg

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: la-calc-macos
        path: dist/la-calc.dmg
