name: Build macOS App

on: 
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build:
    runs-on: macos-latest
    timeout-minutes: 40

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Clean Qt cache
      run: |
        brew uninstall --ignore-dependencies qt@6 || true
        rm -rf /usr/local/opt/qt@6
        brew cleanup

    - name: Install Qt with Brew
      run: |
        brew update
        brew install --force qt@6
        brew link --overwrite qt@6
        sudo ln -sf /usr/local/opt/qt@6/bin/* /usr/local/bin/
        
        # Проверяем наличие macdeployqt
        if [ ! -f /usr/local/opt/qt@6/bin/macdeployqt ]; then
          echo "❌ macdeployqt not found!"
          ls -l /usr/local/opt/qt@6/bin
          exit 1
        fi

    - name: Build application
      run: |
        cd app
        qmake6 la-calc.pro -spec macx-clang CONFIG+=release
        make -j$(sysctl -n hw.ncpu)
        
        # Проверка бинарника
        if [ ! -f la-calc.app/Contents/MacOS/la-calc ]; then
            echo "❌ Binary not found!"
            exit 1
        fi

    - name: Prepare distribution
      run: |
        mkdir -p dist
        cp -R app/la-calc.app dist/
        
        # Явный путь к macdeployqt
        /usr/local/opt/qt@6/bin/macdeployqt dist/la-calc.app -verbose=3
        
        # Проверка результата
        if [ ! -d dist/la-calc.app/Contents/Frameworks ]; then
            echo "❌ Qt frameworks not deployed!"
            exit 1
        fi

    - name: Create DMG
      run: |
        hdiutil create -fs HFS+ \
          -volname "Linear Algebra Calculator" \
          -srcfolder dist/la-calc.app \
          -ov -format UDZO dist/la-calc.dmg
        
        # Проверка DMG
        if [ ! -f dist/la-calc.dmg ]; then
            echo "❌ DMG creation failed!"
            exit 1
        fi

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: la-calc-macos
        path: dist/la-calc.dmg
